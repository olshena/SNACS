---
title: "SNACS"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SNACS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  comment = "#>"
)
```
## Overview
SNACS is an R package for demultiplexing hashes which have simultaneous profiles of single-cell genetic mutations and cell surface antibodies. It identifies the hash of each cell in the mutation data where multiple hashes were profiled concurrently. The hash designations are made based on the mutation and the hash antibody data.

## Load SNACS package
The first step is to load the SNACS package.
```{r setup}
library(SNACS)
```

## Input data format
We have to properly format the input data. SNACS required  a matrix containing the single cell mutation data from the multiplexed profiles of subjects and a matrix containing the hash antibody data of each subject. The mutation data should be a numeric matrix with SNPs in the rows and cells in the columns. 1s represent mutations and 0s non-mutations. The antibody data should be a matrix with subjects in the rows and cells in the columns. The hash antibody values should be continuous numeric measures. Optional cell and SNP level annotations can be provided as data frames.

## Example data
An example data has been included with the package. It has mutation and antibody data from 3 subjects with 750 cells and 24 SNPs. We will demonstrate the package with this data.

Matrix "mutMat" has the mutation data.

```{r, echo = TRUE}

dim(mutMat)
mutMat[1:4,1:4]

```
Matrix "hashMat" has the has antibody data.

```{r, echo = TRUE}

dim(hashMat)
hashMat[,1:4]

```
Matrix "depthTotalMat" has the total depth data.

```{r, echo = TRUE}

dim(depthTotalMat)
depthTotalMat[1:4,1:4]

```
Matrix "depthAltMat" has the alternate depth data.

```{r, echo = TRUE}

dim(depthAltMat)
depthAltMat[1:4,1:4]

```
## Create SNACSList object
SNACS stores data in a simple list-based data object called a SNACSList. The SNACSList object can be made for the example data as follows.
```{r, echo = TRUE}

## Parameters mut, hashes, exptName are mandatory while depthTotalMat, depthAltMat and hashColors are optional. depthTotalMat and depthAltMat are used for making doubletD calls
exptName <- "snacsExpt"
hashColors <- c("indianred2","green3","dodgerblue3")

snacsObj <- SNACSList(mut=mutMat,hashes=hashMat,exptName=exptName,depthTotal=depthTotalMat,depthAlt=depthAltMat,hashColors=hashColors)
snacsObj

```

## Filter data
SNPs and cells with high proportion of missing values should be excluded. We will also filter out SNPs with low or high proportion of mutations.

```{r, echo = TRUE}

snacsObj <- filterData(snacsObj=snacsObj)
snacsObj

```

## Cluster antibody data to select best SNPs to demultiplex hashes
The cells are clustered based on mutation data. The clustering takes place in two steps. First, mutation data is clustered based on all SNPs. An intermediate heatmap is generated identifying the cell clusters representing the hashes and the SNPs ranked by how well they separate the clusters. Then a second round of clustering is performed to select SNPs which best separate the cell clusters from the first round. We can specify "pdf" or "png" format for the figures. The ouputs are then saved in the "../output" folder.

The "heatmap of ranked SNPs" shows the 3 clusters, delineated in red, separating the cells from the 3 subjects after the first round of clustering of the example data. The continuous antibody data for each subject are shown as grey color bars.

The "heatmap of best SNPs" shows the 3 clusters, delineated in red, after the second round of clustering of the example data. The color bar with the light blue, yellow and dark blue clusters shows the cluster designations from the first round of clustering. Again, the continuous antibody data are shown as grey color bars.

The cluster designations from the first round of clustering are saved in the column "clustRankedSNPs_hclust" of the "annCell" attribute of the "SNACSList" object. The output from the second round of clustering, which is an "hclust" object, is saved as the attribute "hclustObj_bestSNPs". This attribute is later used is making the hash calls.

```{r, echo = TRUE}

snacsObj <- getBestSNPs(snacsObj)
snacsObj

```

## Impute missing mutations
Currently, SNACS package cannot work on mutation data with missing values. We can impute missing mutations as follows.

```{r, echo = TRUE}

snacsObj <- imputeMissingMutations(snacsObj=snacsObj)
snacsObj

```

## Cluster mutation data to select best SNPs to demultiplex hashes
The cells are clustered based on mutation data. The clustering takes place in two steps. First, mutation data is clustered based on all SNPs. An intermediate heatmap is generated identifying the cell clusters representing the hashes and the SNPs ranked by how well they separate the clusters. Then a second round of clustering is performed to select SNPs which best separate the cell clusters from the first round. We can specify "pdf" or "png" format for the figures. The ouputs are then saved in the "../output" folder.

The "heatmap of ranked SNPs" shows the 3 clusters, delineated in red, separating the cells from the 3 subjects after the first round of clustering of the example data. The continuous antibody data for each subject are shown as grey color bars.

The "heatmap of best SNPs" shows the 3 clusters, delineated in red, after the second round of clustering of the example data. The color bar with the light blue, yellow and dark blue clusters shows the cluster designations from the first round of clustering. Again, the continuous antibody data are shown as grey color bars.

The cluster designations from the first round of clustering are saved in the column "clustRankedSNPs_hclust" of the "annCell" attribute of the "SNACSList" object. The output from the second round of clustering, which is an "hclust" object, is saved as the attribute "hclustObj_bestSNPs". This attribute is later used is making the hash calls.

```{r, echo = TRUE}

snacsObj <- clusterCellsWithSNPdata(snacsObj)
snacsObj

```

## Make hash calls
This is the final step for demultiplexing the hashes. The cluster information from the mutation data and the hash antibody data are used to make hash calls. Each cell is assigned the ID of one of the hashes or called a multiplet when it is a mixture of hashes. Expecting the mutation data of cells with similar hash profiles to cluster together, the cells are split into sub-clusters and each cluster is assigned a hash ID if enough proportion of cells in the cluster have signal above the background of that hash. The hash calls are saved in the "hashCallRnd1" column in the "annCell" table of the SNACS object. A refined version of the hash calls are saved in the "hashCallRnd2" column in the "annCell" table where regions of multiplets too narrow to be picked up in the first round are marked.

```{r, echo = TRUE}

snacsObj=makeHashCall(snacsObj)

## The hash calls are saved in the "annCell" table in the SNACSList object
snacsObj$annCell[1:4,]

```

## Refine multiplet calls with doubletD
The hash calls can be further refined by applying doubletD method. Doublets identified by doubletD will be added to the second round of hash calls. These calls are saved in the "snacsPlusDoubletDCall" column in the "annCell" table of the SNACS object.

```{r, echo = TRUE}

snacsObj=runSNACSplusDoubletD(snacsObj)

## The SNACS plus doubletD based hash calls are saved in the "annCell" table in the SNACSList object
snacsObj$annCell[1:4,]

```

## Annotate heatmap
Custom cell and SNP annotations can be added to the heatmaps. Here the heatmap of the best SNPS are annotated with color bars for the hash calls along with the clusters from the first round of clustering, and the hash antibody measures.
The parameter "outputFormat" can be used to save the heatmap in "pdf" or "png" format. The output is then saved in "../output" folder.

```{r, fig.show = "hold", out.width = "50%", echo = TRUE}

createHeatmap(snacsObj,
   cell_anno_var=c("snacsPlusDoubletDCall","doubletDCall","hashCallRnd2","hashCallRnd1",snacsObj$annHash$hashNames,"clustRankedSNPs_hclust"),
   cell_anno_name=c("snacs+DD","doubletD","hashCallRnd2","hashCallRnd1",snacsObj$annHash$hashNames,"cluster"),
   outputFormat="")

```

