---
title: "SNACS"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SNACS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  comment = "#>"
)
```
## Overview
SNACS is an R package for demultiplexing hashes which have simultaneous profiles of single-cell genetic mutations and cell surface antibodies. It identifies the hash of each cell in the mutation data where multiple hashes were profiled concurrently. The hash designations are made based on the mutation and the hash antibody data.

## Load SNACS package
The first step is to load the SNACS package.
```{r setup}
library(SNACS)
```

## Input data format
We have to properly format the input data. SNACS required  a matrix containing the single cell mutation data from the multiplexed profiles of subjects and a matrix containing the hash antibody data of each subject. The mutation data should be a numeric matrix with SNPs in the rows and cells in the columns. 1s represent mutations and 0s non-mutations. The antibody data should be a matrix with subjects in the rows and cells in the columns. The hash antibody values should be continuous numeric measures. Optional cell and SNP level annotations can be provided as data frames.

## Example data
An example data has been included with the package. It has mutation and antibody data from 3 subjects with 750 cells and 24 SNPs. We will demonstrate the package with this data.

Matrix "mutMat" has the mutation data.

```{r, echo = TRUE}

dim(mutMat)
mutMat[1:4,1:4]

```
Matrix "hashMat" has the has antibody data.

```{r, echo = TRUE}

dim(hashMat)
hashMat[,1:4]

```
Matrix "depthTotalMat" has the total depth data.

```{r, echo = TRUE}

dim(depthTotalMat)
depthTotalMat[1:4,1:4]

```
Matrix "depthAltMat" has the alternate depth data.

```{r, echo = TRUE}

dim(depthAltMat)
depthAltMat[1:4,1:4]

```
## Create SNACSList object
SNACS stores data in a simple list-based data object called a SNACSList. The SNACSList object can be made for the example data as follows.
```{r, echo = TRUE}

## Parameters mut, hashes, exptName are mandatory while depthTotalMat, depthAltMat and hashColors are optional. depthTotalMat and depthAltMat are used for making doubletD calls
exptName <- "snacsExpt"
hashColors <- c("indianred2","green3","dodgerblue3")

snacsObj <- SNACSList(mut=mutMat,hashes=hashMat,exptName=exptName,depthTotal=depthTotalMat,depthAlt=depthAltMat,hashColors=hashColors)
snacsObj

```

## Filter data
SNPs and cells with high proportion of missing values should be excluded. We will also filter out SNPs with low or high proportion of mutations.

```{r, echo = TRUE}

snacsObj <- filterData(snacsObj=snacsObj)
snacsObj

```

## Cluster antibody data to select best SNPs to demultiplex hashes
Group cells into constituent samples based on hash antibody data. Select the best SNPs that separate the cell groups using the mutation data.

```{r, echo = TRUE}

snacsObj <- getBestSNPs(snacsObj)
snacsObj

```

## Impute missing mutations
Currently, SNACS package cannot work on mutation data with missing values.SNACS imputes missing mutations using k nearest neighbor approach.

```{r, echo = TRUE}

snacsObj <- imputeMissingMutations(snacsObj=snacsObj)
snacsObj

```

## Cluster cells based on the SNP data
Cluster cells, where the number of clusters is the number of constituent samples, using the mutation data with the selected SNPs. Generate heatmap of the mutation data.

```{r, echo = TRUE}

snacsObj <- clusterCellsWithSNPdata(snacsObj)
snacsObj

```

## Make SNACS calls
This is the final step for demultiplexing the hashes. Make SNACS calls based on mutation and hash antibody data. The cluster information from the mutation data and the hash antibody data are used to make SNACS calls. Each cell is assigned one of the hash IDs (a single sample) or a set of hash IDs (a multiplet), when it is a mixture of samples. The distribution of the antibody measure of a hash is expected to be a mixture of a background and a foreground signal where the latter signals the presence of antibody for the hash. The clusters based on mutation data give a rough assignment of SNACS calls. The SNACS calls are refined by looking at the antibody data of the cells which cluster together. The cell clusters obtained from running "clusterCellsWithSNPdata" are split into sub-clusters and each sub-cluster is assigned a hash ID if enough cells in that group have a signal above the background for the corresponding hash. The sub-clusters are created using the cell clusters from the second round of hierarchical clustering of the mutation data. First the antibody measures of the top two cluster pairs are compared using Hotelling's T2 test. If there is significant difference , the two clusters are splits into sub-clusters and each of those cluster pairs are tested for difference. The tree is traversed until there are no pairs of significantly different cluster pairs. The splitting of a cluster stops when it reaches a minimum number of cells. The singlet and multiplet assignments are made to each of the sub-clusters using the hash antibody data. The antibody expression for a sample is expected to have a bimodal distribution representing a background, which are cells not from the sample, and a foreground, which are cells belonging to the sample. The background distribution is estimated by considering the data from the lower bound till the mode of the background and generating a symmetrical distribution from it. Then, the empirical cumulative distribution function of this distribution becomes the estimated background distribution. A sub-cluster is assigned the ID of each sample which has at least a certain proportion of cells, defined by the parameter "cellProportionAboveBackgnd", with antibody expression above a certain quantile, defined by the parameter "backgndThreshold", of the hash background. A sub-cluster with multiple samples above their corresponding hash background is considered a multiplet. The result is stored in the column "snacsRnd1" in the "annCell" table of the SNACS object. These calls are refined by detecting narrow regions of multiplets. The cells, ordered as in the clusters above, are segmented by applying circular binary segmentation (CBS) on the distance to the centroid of the SNACS call groups. A segment is assigned the ID of each hash which has at least a certain proportion of cells, defined by the parameter "cellProportionAboveBackgnd", with antibody expression above a certain quantile, defined by the parameter "backgndThresRnd2", of the hash background. A segment with multiple hashes above their corresponding hash background is considered a multiplet. Only narrow segments, specified by "maxClustSizeRnd2", are considered. The result is stored in the column "snacsRnd2" in the "annCell" table of the SNACS object

```{r, echo = TRUE}

snacsObj=makeSnacsCall(snacsObj)

## The SNACS calls are saved in the "annCell" table in the SNACSList object
snacsObj$annCell[1:4,]

```

## Refine multiplet calls with doubletD
The SNACS calls can be further refined by applying doubletD method. Doublets identified by doubletD will be added to the second round of SNACS calls. These calls are saved in the "snacsPlusDoubletD" column in the "annCell" table of the SNACS object.

```{r, echo = TRUE}

snacsObj=runSNACSplusDoubletD(snacsObj)

## The SNACS plus doubletD based SNACS calls are saved in the "annCell" table in the SNACSList object
snacsObj$annCell[1:4,]

```

## Annotate heatmap
Custom cell and SNP annotations can be added to the heatmaps. Here the heatmap of the best SNPS are annotated with color bars for the SNACS calls along with the clusters from the first round of clustering, and the hash antibody measures.
The parameter "outputFormat" can be used to save the heatmap in "pdf" or "png" format. The output is then saved in "../output" folder.

```{r, fig.show = "hold", out.width = "100%", echo = TRUE}

createHeatmap(snacsObj,
   cell_anno_var=c("snacsPlusDoubletD","doubletD","snacsRnd2","snacsRnd1",snacsObj$annHash$hashNames,"clustBestSNPs_hclust"),
   cell_anno_name=c("snacs+DD","doubletD","snacsRnd2","snacsRnd1",snacsObj$annHash$hashNames,"cluster"),
   outputFormat="")

```

